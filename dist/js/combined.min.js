var devenv=window.location.hostname.indexOf("axelysolboda")<0,firebaseLocation=devenv?"https://bodaaxelysol-dev.firebaseio.com":"https://axelysolboda.firebaseio.com",fBaseRef=new Firebase(firebaseLocation),groupsRef=fBaseRef.child("groups"),groupsIndexRef=fBaseRef.child("groupsIndex"),usersRef=fBaseRef.child("users"),profilesRef=fBaseRef.child("profiles"),mailingListRef=fBaseRef.child("mailingList"),commentsRef=fBaseRef.child("comments"),photosRef=fBaseRef.child("photos");devenv||(!function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=1*new Date,f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-51910441-1","axelysolboda.appspot.com"));var weddingModule=angular.module("wedding",["ngRoute","firebase","angulartics","angulartics.google.analytics"]),NO_GROUP_ID="AAAA0000",addToHome=addToHomescreen({skipFirstVisit:!0,maxDisplayCount:1,startDelay:-.5}),fLoaderFunction=function(a,b,c,d,e){var f=function(){var c=a.defer(),d=b(e);return d.$on("loaded",function(){d.$off("loaded"),d.hasOwnProperty("$value")&&null==d.$value?c.reject("No object found at path: "+d.$getRef().toString()):c.resolve(d)}),c.promise},g=function(){var b=a.defer(),e=c(fBaseRef),f=function(){return e.$login("password",{email:d+"@barakka.org",password:d.toUpperCase(),debug:!0}).then(function(a){b.resolve(a)},function(){b.reject("User not logged in.")})};return e.$getCurrentUser().then(function(a){a?a.email.toLowerCase()==(d+"@barakka.org").toLowerCase()?b.resolve(a):(e.$logout(),b.reject("Already logged in with a different user.")):f()},f),b.promise};return g().then(f)};weddingModule.config(["$routeProvider",function(a){var b=function(){return["$q","$firebase","$firebaseSimpleLogin","$route",function(a,b,c,d){var e=d.current.params.groupId;return e!=NO_GROUP_ID?fLoaderFunction(a,b,c,e,groupsRef.child(e)):{id:NO_GROUP_ID,anonymous:!0}}]},c=function(){return["$q","$firebase","$firebaseSimpleLogin","$route",function(a,b,c,d){var e=d.current.params.groupId;return e!=NO_GROUP_ID?fLoaderFunction(a,b,c,e,profilesRef.child(e)).then(function(a){return a},function(){var a=b(profilesRef.child(e));return a.complete=!1,a.stage=0,a.participationConfirmed=!1,a.inMailingList=!0,a}):{complete:!0}}]};a.when("/login",{templateUrl:"partials/login.html",controller:"LoginCtrl",resolve:{group:function(){return null},profile:function(){return null}}}).when("/:groupId/home",{templateUrl:"partials/home.html",controller:"HomeCtrl",resolve:{group:b(),profile:c()}}).when("/:groupId/us",{templateUrl:"partials/us.html",controller:"StaticCtrl",resolve:{group:b(),profile:function(){return null}}}).when("/:groupId/invitation",{templateUrl:"partials/invitation.html",controller:"StaticCtrl",resolve:{group:b(),profile:function(){return null}}}).when("/:groupId/calendar",{templateUrl:"partials/calendar.html",controller:"CalendarCtrl",resolve:{group:b()}}).when("/:groupId/church",{templateUrl:"partials/church.html",controller:"StaticCtrl",resolve:{group:b(),profile:function(){return null}}}).when("/:groupId/dinner",{templateUrl:"partials/dinner.html",controller:"StaticCtrl",resolve:{group:b(),profile:function(){return null}}}).when("/:groupId/upload/:key?",{templateUrl:"partials/upload.html",controller:"UploadCtrl",resolve:{group:b()}}).when("/:groupId/comment",{templateUrl:"partials/comment.html",controller:"CommentsCtrl",resolve:{group:b()}}).when("/:groupId/accommodation/:section?",{templateUrl:"partials/accommodation.html",controller:"AccommodationCtrl",resolve:{group:b()}}).when("/:groupId/other",{templateUrl:"partials/other.html",controller:"StaticCtrl",resolve:{group:b(),profile:c()}}).when("/:groupId/present",{templateUrl:"partials/present.html",controller:"StaticCtrl",resolve:{group:b(),profile:function(){return null}}}).when("/:groupId/contacts",{templateUrl:"partials/contacts.html",controller:"StaticCtrl",resolve:{group:b(),profile:function(){return null}}}).when("/:groupId/flashmob",{templateUrl:"partials/flashmob.html",controller:"StaticCtrl",resolve:{group:b(),profile:function(){return null}}}).when("/:groupId/survey/:stageId",{templateUrl:"partials/survey.html",controller:"SurveyCtrl",resolve:{group:b(),profile:c()}}).when("/:groupId",{redirectTo:function(a){return"/"+a.groupId+"/home"}}).otherwise({redirectTo:"/login"})}]),weddingModule.factory("fireLoader",["$q","$firebase","$firebaseSimpleLogin",function(a,b,c){return function(d,e){return fLoaderFunction(a,b,c,d,e)}}]),weddingModule.controller("IndexCtrl",["$scope","$location","$route",function(a,b){a.bodyStyle="";var c=function(){var a=b.path().split("/");if(a.length>2){var c=a[2];return("us"==a[2]||"invitation"==a[2]||"church"==a[2]||"dinner"==a[2]||"calendar"==a[2]||"accommodation"==a[2]||"comment"==a[2]||"upload"==a[2]||"present"==a[2]||"contacts"==a[2]||"flashmob"==a[2])&&(c+=" static-inner"),c}return a[a.length-1]};a.$on("$viewContentLoaded",function(){a.bodyStyle=c()}),a.$on("$routeChangeError",function(){b.path("/login").replace()}),a.back=function(){window.history.back()},a.reload=function(){location.reload()},a.isWebApp=function(){return 1==window.navigator.standalone}}]),weddingModule.controller("LoginCtrl",["$scope","$location","fireLoader","$firebaseSimpleLogin",function(a,b,c,d){a.loading=!1,a.access=function(){if(a.signinForm.group.$valid){a.loading=!0;var d=a.groupId.toUpperCase();c(d,groupsRef.child(d)).then(function(){b.path("/"+d+"/home")},function(){a.loading=!1,a.signinForm.group.$setValidity("pattern",!1)})}},d(fBaseRef).$logout()}]),weddingModule.controller("HomeCtrl",["$scope","$location","group","profile",function(a,b,c,d){a.group=c,d.complete||(!d.lastModified||moment().isAfter(moment(d.lastModified).add("hours",4)))&&(d.stage?b.path("/"+c.id+"/survey/"+d.stage).replace():b.path("/"+c.id+"/survey/0").replace()),a.goTo=function(a){"questionnaire"!=a?(console.log("/"+c.id+"/"+a),b.path("/"+c.id+"/"+a)):b.path("/"+c.id+"/survey/1")}}]),weddingModule.controller("StaticCtrl",["$scope","$location","group","profile",function(a,b,c,d){a.openChurchMap=function(){var a=$.ua.os.name;return"iOS"==a||"Mac OS X"==a?"http://maps.apple.com/?q=Iglesia+de+San+Juan+del+Hospital":"Android"==a?"geo:0,0?q=Iglesia+de+San+Juan+del+Hospital":"http://maps.google.com/?q=Iglesia+de+San+Juan+del+Hospital"},a.openDinnerMap=function(){var a=$.ua.os.name;return"iOS"==a||"Mac OS X"==a?"http://maps.apple.com/?q=Calle+102+37+Ribarroja+Valencia":"Android"==a?"geo:39.550424,-0.538643":"http://maps.google.com/?q=Calle+103,+37,+ribarroja"},a.openBusMap=function(){alert("¡Hemos dicho próximamente!")},a.goTo=function(a){"questionnaire"!=a?(console.log("/"+c.id+"/"+a),b.path("/"+c.id+"/"+a)):b.path("/"+c.id+"/survey/1")},a.isMobile=function(){var a=$.ua.os.name;return"iOS"==a||"Android"==a},a.showAddToHome=function(){b.path("/"+c.id+"/home"),addToHome.show(!0)},a.isFlashMob=function(){return d?1==d.flashMob:!1}}]),weddingModule.controller("SurveyCtrl",["$scope","group","$routeParams","$location","profile","$firebase",function(a,b,c,d,e,f){var g={intro:0,participation:1,participants:2,dinnerRequirements:3,transportation:4,accomodation:5,other:6,participantsDetails:7},h=function(){e.stage=a.stage,e.lastModified=new Date};a.group=b,a.stage=parseInt(c.stageId),a.profile=e,a.users=f(usersRef.child(c.groupId)),e.stage||(e.complete=!1,e.stage=0,e.participationConfirmed=!1,e.inMailingList=!0),h(),a.profile.$save(),a.next=function(){a.stage==g.participation&&0==e.participationConfirmed?a.stage=g.participantsDetails:a.stage==g.transportation&&"Valencia"==e.origin?a.stage=g.participantsDetails:a.stage+=1,h(),e.$save().then(function(){d.path("/"+b.id+"/survey/"+a.stage)})},a.remove=function(b){a.users.$remove(b)};var i=function(){var b=[];return a.users&&angular.forEach(a.users.$getIndex(),function(c){var d=a.users[c];d.predefined&&d.email&&b.push(d.email)},this),b};a.hasPredefined=function(){return i().length>0},a.save=function(){h(),e.complete=!0,a.users.$save().then(function(){if(f(mailingListRef.child(b.$id)).$remove(),e.inMailingList){var c=i();c.length>0&&angular.forEach(c,function(a){f(mailingListRef.child(b.$id)).$add(a)})}e.$save().then(function(){e.needsAccommodation?$("#accommodationAlert").on("hidden.bs.modal",function(){a.$apply(function(){d.path("/"+b.id+"/home").replace()})}).modal():d.path("/"+b.id+"/home").replace()})})},a.cancel=function(){d.path("/"+b.id+"/home").replace()},a.editableUser=null,a.editableIndex=null,a.editEditableUser=function(b){a.editableUser=angular.copy(a.users[b]),a.editableIndex=b},a.addEditableUser=function(){a.editableUser={name:null,email:null},a.editableIndex=null},a.cancelEditableUser=function(){a.editableUser=null,a.editableIndex=null},a.saveEditableUser=function(){a.editableIndex?a.users[a.editableIndex]=a.editableUser:a.users.$add(a.editableUser),a.editableUser=null,a.editableIndex=null}}]),weddingModule.controller("CalendarCtrl",["$scope","group",function(a){a.event=null,a.$on("$viewContentLoaded",function(){$("#scheduler").fullCalendar({defaultDate:"2014-09-06",events:"https://www.google.com/calendar/feeds/barakka.org_8g6smdg6nt1ge257qk26o1ekg8%40group.calendar.google.com/public/basic",header:{left:"title",center:"",right:""},eventClick:function(b){return a.event=b,a.$digest(),!1}})}),a.closeEvent=function(){a.event=null},a.next=function(){$("#scheduler").fullCalendar("next")},a.prev=function(){$("#scheduler").fullCalendar("prev")},a.today=function(){$("#scheduler").fullCalendar("today")}}]),weddingModule.controller("CommentsCtrl",["$scope","$firebase","group","fireLoader",function(a,b,c){a.sending=!1,a.composing=!1,a.comments=b(commentsRef.child("public").endAt().limit(20));var d=function(){a.comment={to:"Wall",from:c.name}};a.addComment=function(){a.composing=!0},a.cancelComment=function(){a.composing=!1,d()},a.saveComment=function(){a.sending=!0,a.comment.date=new Date,a.comment.group=c.$id;var e=commentsRef.child("Wall"==a.comment.to?"public":"private");b(e).$add(a.comment).then(function(){d(),a.sending=!1,a.composing=!1},function(){alert("Ha ocurrido un error al enviar el mensaje. Intentalo de nuevo."),a.sending=!1})},d()}]),weddingModule.controller("CommentCtrl",["$scope",function(a){a.date=moment(a.comment.date).format("lll")}]),weddingModule.controller("UploadCtrl",["$scope","$http","$firebase","group",function(a,b,c,d){function e(b){b.files&&(angular.forEach(b.files,function(a,b){var c=new FileReader;c.onload=function(a){$("#image-preview"+b).css("background-image","url("+a.target.result+")"),$("#frame-preview"+b).show()},c.readAsDataURL(a)}),a.previewImages=b.files,a.$apply())}var f="",g=function(){a.photoDetails={title:null,comment:null,keys:null}};a.sending=!1,b.get("/backend/"+d.id+"/newblob").success(function(a){f=a}),a.upload=function(){a.photoDetails.keys=null,a.sending=!0;var e=new FormData($("#uploadForm")[0]);b.post(f,e,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(b){a.photoDetails.keys=b,c(photosRef.child(d.id)).$add(a.photoDetails).then(function(){a.sending=!1,a.previewImages=null},function(b){a.sending=!1,console.error("Error uploading photodetails to firebase. "+b)})}).error(function(){a.sending=!1,console.error("Error uploading photo to blobstore")})},a.chooseImage=function(){$("#image-selector").trigger("click")},$("#image-selector").change(function(){e(this)}),a.imageStyle=function(a){return{"background-image":"url('/backend/blob/"+a+"')"}},a.uploadMore=function(){g()},g()}]),weddingModule.controller("AccommodationCtrl",["$scope","$routeParams","$location","group",function(a,b,c,d){a.currentSection=b.section,a.openSection=function(a){c.path("/"+d.id+"/accommodation/"+a)};var e={congress:"Zona Palacio de Congresos",center:"Zona Iglesia / Centro",outside:"Zona Eliana / Las afueras",alternatives:"Alternativas"};a.pageTitle=function(){return e[a.currentSection]?e[a.currentSection]:"Alojamiento"}}]);